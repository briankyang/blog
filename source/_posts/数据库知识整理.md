---
title: 数据库知识整理
date: 2020-03-21 16:46:41
tags: 数据库
---

# Mysql数据库知识整理

## 锁机制

##### 基本概念

- 功能: 协调多个会话中多线程并发访问相同资源时，资源占用问题。

- 贯彻模块: 索引，锁机制，事务

- 锁概念
  
  - 共享锁、排它锁
  
  - 表锁、行级锁、间隙锁

##### 表级锁

- 两种锁: 共享读锁，排它写锁

- MyISAM存储引擎
  
  - 只支持表级锁, 因此MyISAM引擎读写操作之间，写写操作之间是串行化的。
  
  - 当一次会话线程获取表的写锁后，只有当前持有该写锁的会话线程可以对表进行操作，其他线程的读写都会等待，直到锁释放 

## 存储引擎

#### MyISAM

- 专注性能，不支持事务，只支持表级锁

#### InnoDB

- 支持事务，支持表级锁、行级锁、间隙锁

- 采用MVCC来支持高并发，算是乐观锁吧

- MVCC
  
  - 基本原理: 通过在每行数据增加3个隐藏列来实现, DB_TRX_ID(最后被哪个事务修改), DB_ROLLBACK_PTR(指向undolog的指针, 指向回滚日志的指针), flag(是否被删除)，然后查询时的时候根据记录的这三个隐藏列信息及当前(或事务一开始的)数据库的事务信息去筛选列是否被包含进试图, 然后就解决了脏读或不可重复读的问题
  
  - 两种读方式
    
    - 快照读：读取的只是当前事务的可见版本，不用加锁, MVCC实现
    
    - 当前读：读取的是当前版本，会加锁，如lock in share mode, for update, update, insert, delete都会加锁，加的是行级锁和或行级锁和间隙锁，读取的是最新版本
  
  - 基本概念
    
    - undoLog：事务回滚日志
      
      - insert类型的undoLog
        
        - insert事务完成后可以直接删除
      
      - update类型的undoLog
        
        - update事务完成后需等到系统没有比当前undoLog更早的read-view时才可删除
    
    - read-view: 包含3个字段
      
      - alive_trx_list:正在活跃的事务id(包含当前事务)
      
      - up_limit_id:上面的id中最小的一个
      
      - low_limit_id: 上面id中最大的一个加一
  
  - 实现原理
    
    - 通过在每行记录后面保存三个隐藏的列来实现
      
      - DB_TRX_ID：自动创建的事务id
      
      - DB_ROLLBACK_PTR：指向回滚日志的指针
      
      - flag: 是否删除
    
    - RR模式下事务第一次获取到活跃事务列表后就保存一份快照(snapshotview)，后续根据这个快照来获取视图
    
    - RC模式下每次读都会从系统获取当前的活跃事务(readview)
    
    - 获取行记录
    
    - 判断行的DB_TRX_ID是否小于readview的最小的或等于当前id, 若是则可以直接读这行记录
    
    - 是否大于等于low_limit_id，若是则不可见，根据回滚指针去undoLog查询上一条记录
    
    - 是否在活跃事务列表(RR模式活跃事务列表在事务一开始就确定了，RC模式下每次快照读都会获取最新的活跃事务列表)，若是则不可见，根据回滚指针获取上一条记录
    
    - 否则可见
  
  - 幻读
    
    - 定义
      
      指一个事务前后两次查询同一个范围的时候，后一次查询到了前一次没有看到的行
    
    - 例子
      
      - 事务A按照一定条件进行数据读取，期间事务B插入了相同搜索条件的新数据，事务A再读，事务A发现了事务B插入的数据，幻读出现
        
        - 若事务A按一定条件搜索期间事务B删除了符合条件的某一条数据，A读少了，这归为不可重复读
    
    - 产生
      
      - 快照读和当前读混用
    
    - 解决办法
      
      - 当前读，通过加行锁和间隙锁阻止新数据插入，如事务A读取
  
  - 注意：MVCC只在可重复读和读已提交两个隔离级别下才能正常工作

## 索引

- MyISAM
  
  - B+树索引
  
  - 索引和数据文件分开，索引叶节点存储数据记录的地址

- InnoDB
  
  - B+树索引
  
  - 主键索引
    
    - 表数据文件本身就是按B+树组织的一个索引结构，这个索引是主键索引，所以Innodb必须要有主键
  
  - 辅助索引
    
    - 叶节点存储相应记录主键的值，使用时首先检索辅助索引获得主键的值，然后用主键到主键索引中检索获得记录

- B+树索引
  
  - 磁盘读写代价更低，内部节点没有指向关键字具体信息的指针，因此内部节点相对B树更小
  
  - 数据都存储在叶子节点，方便区间查询

## 事务

4个特性

- 原子性
  
  - 不可分割的操作单元，要么全部成功，要么全部失败

- 一致性
  
  - 事务开始前到结束后，数据库的完整性约束没有被破坏

- 隔离性
  
  - 每个事务与其他事务之间彼此独立和透明，互不影响

- 持久性
  
  - 事务一旦提交，其对数据的影响是永久性的。

## 隔离级别

|      | 脏读  | 不可重复读 | 幻读  |
| ---- | --- | ----- | --- |
| 读未提交 | 可能  | 可能    | 可能  |
| 读已提交 | 不可能 | 可能    | 可能  |
| 可重复读 | 不可能 | 不可能   | 可能  |
| 序列化  | 不可能 | 不可能   | 不可能 |
